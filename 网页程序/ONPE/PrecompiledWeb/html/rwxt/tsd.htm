<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/color.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/demo/demo.css">
    <link rel="stylesheet" type="text/css" href="../../css/fitem.css">
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../Scripts/EasyUI/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../Scripts/Common/common.js"></script>
    <script type="text/javascript" src="../../Scripts/Common/json.js"></script>
</head>
<body>
    
    <table id="dg" style="width:100%; height:550px"></table>


</body>
</html>
<script type="text/javascript">
    var selRow;
    var tsdid;

    var effectRow;
    var editIndex = undefined;

    $(function () {
        $('#dg').datagrid({
            url: '../../ashx/tsd/tsdHandler.ashx?type=grid',
            method: 'post',
            singleSelect: true,
            collapsible: true,
            fit: true,
            frozenColumns: [[
                { field: 'dIntNote', title: '序号', width: 158, align: 'center', hidden: 'true' },
                { field: 'dVchWorkNote', title: '工作票号', width: 158, align: 'center' },
                { field: 'equip_name', title: '设备名称', width: 160, align: 'center', styler: ChangeCellStyler }
                ]],
            columns: [[

                { field: 'equip_cdh', title: '传动号', width: 100, align: 'center', editor: "textbox" },
                { field: 'requestUnit', title: '申请停电单位', width: 100, align: 'center', editor: "textbox" },
                { field: 'requestPeo', title: '联系人', width: 80, align: 'center', editor: "textbox" },
                { field: 'requestStopTime', title: '申请停电时间', width: 130, align: 'center', editor: "datetimebox", formatter: strFormatDate },
                { field: 'actionStopTime', title: '停电执行时间', width: 130, align: 'center', editor: "datetimebox", formatter: strFormatDate },
                { field: 'actionStopPeo', title: '停电执行人', width: 80, align: 'center', editor: "textbox" },
                { field: 'requestEndUnit', title: '申请送电单位', width: 100, align: 'center', editor: "textbox" },
                { field: 'requestEndPeo', title: '联系人', width: 80, align: 'center', editor: "textbox" },
                { field: 'requestEndTime', title: '申请送电时间', width: 130, align: 'center', editor: "datetimebox", formatter: strFormatDate },
                { field: 'actionEndTime', title: '送电执行时间', width: 130, align: 'center', editor: "datetimebox", formatter: strFormatDate },
                { field: 'actionEndPeo', title: '送电执行人', width: 80, align: 'center', editor: "textbox" },
                { field: 'dVchRemark', title: '备注', width: 80, align: 'center', editor: "textbox" }
            ]],
            toolbar: [{
                text: '删除',
                iconCls: 'icon-cut',
                handler: function () {
                    if (selRow != undefined ) {
                        parent.$.messager.confirm("操作提示", "您确定要执行删除操作吗？", function (data) {
                            if (data) {
                                var row = $('#dg').datagrid('getSelected');
                                if (row) {
                                    var rowIndex = $('#dg').datagrid('getRowIndex', row);
                                    $('#dg').datagrid('deleteRow', rowIndex);
                                }
                            }
                            else {
                            }
                        });
                    }
                    else {
                        parent.$.messager.alert("操作提示", "请选择要删除的数据！", "info");
                    }
                }
            }, {
                text: '提交',
                iconCls: 'icon-undo',
                handler: function () {
                    endEditing();
                    if ($('#dg').datagrid('getChanges').length) {
                        var inserted = $('#dg').datagrid('getChanges', "inserted");
                        var deleted = $('#dg').datagrid('getChanges', "deleted");
                        var updated = $('#dg').datagrid('getChanges', "updated");

                        effectRow = new Object();
                        if (inserted.length) {
                            effectRow["inserted"] = JSON.stringify(inserted);
                        }
                        if (deleted.length) {
                            effectRow["deleted"] = JSON.stringify(deleted);
                        }
                        if (updated.length) {
                            effectRow["updated"] = JSON.stringify(updated);
                        }
                    }
                }
            }, {
                text: '保存',
                iconCls: 'icon-save',
                handler: function () {

                    var rows = $('#dg').datagrid('getChanges');

                    if (rows.length != 0) {
                        if (effectRow == undefined) {
                            showMsg("操作提示", "请先提交编辑操作！", "info")
                        }
                        else {
                            update();
                        }
                    }

                }
            }],

            onLoadSuccess: function (data) {
                //                for (var i = 0; i < data.rows.length; i++) {
                //                    ChangeCellStyler(data.rows[i]);
                //                }
            },
            onSelect: function (index, row) {
                tsdid = row.dIntNote;
                selRow = row;
            },
            onClickRow: function (index, row) {
                if (editIndex != index) {
                    if (endEditing()) {
                        $('#dg').datagrid('selectRow', index);
                        $('#dg').datagrid('beginEdit', index);
                        editIndex = index;
                    } else {
                        $('#dg').datagrid('selectRow', editIndex);
                    }
                }
            }

        });
    });
    function ChangeCellStyler(value, row, index) {
        var sty = "";
        $.ajax({
            url: "../../ashx/tsd/tsdHandler.ashx?type=end&code=" + row.equip_code,
            data: '',
            type: 'post',
            async: false,
            dataType: 'text',
            success: function (msg) {
                //如果返回为1，表示不能送电   0可以送电
//                alert(row.actionEndTime.split(' ')[1]);
                if (row.actionEndTime.split(' ')[1] == undefined) {
                    if (msg == '1') {
                        sty = 'background-color:#ff9999;color:black;';//红色
                    }
                    if (msg == '0') {
                        sty = 'background-color:#33ff66;color:black;';//绿色
                    }
                }

                if (row.actionEndTime.split(' ')[1] == '0:00:00' || row.actionEndTime.split(' ')[1] == '00:00:00') {
                    if (msg == '1') {
                        sty = 'background-color:#ff9999;color:black;'; //红色
                    }
                    if (msg == '0') {
                        sty = 'background-color:#33ff66;color:black;'; //绿色
                    }
                }
                if (row.actionEndTime.split(' ')[1] != '0:00:00' && row.actionEndTime.split(' ')[1] != '00:00:00') {
                    //在之前的记录中已经送电了
                }
                if (row.actionEndTime.split(' ')[1] != undefined) {
                    if (row.actionEndTime.split(' ')[1] != '0:00:00' && row.actionEndTime.split(' ')[1] != '00:00:00') {

                    }
                    else {

                    }
                }
            }
        });
        return sty;
    }
    function update() {
        $.ajax({
            url: "../../ashx/tsd/tsdHandler.ashx?type=save&tsdid=" + tsdid,
            data: effectRow,
            type: 'post',
            async: false,
            dataType: 'text',
            success: function (msg) {
                if (msg == 'ok') {
                    $('#dg').datagrid('acceptChanges');
                    showMsg("操作提示", "数据更新成功！", "info")
                }
                else {
                    showMsg("操作提示", "数据更新失败！", "error")
                }
            }
        })

        $('#dg').datagrid('reload');
    }
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#dg').datagrid('validateRow', editIndex)) {
            $('#dg').datagrid('endEdit', editIndex);
            editIndex = undefined;
            return true;
        } else {
            return false;
        }
    }

</script>