<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/color.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/demo/demo.css">
    <link rel="stylesheet" type="text/css" href="../../css/fitem.css">
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.easyui.min.js"></script>
    <script src="../../Scripts/EasyUI/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script type="text/javascript" src="../../Scripts/Common/common.js"></script>
</head>
<body>
    <table id="dg" data-options="fit:true">
    </table>
    <div id="addJob" class="easyui-window" title="" data-options="iconCls:'icon-save'"
        style="width: 480px; height: 240px; padding: 5px;">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'center'" style="padding: 10px;">
                <form id="ff">
                <input type="hidden" id="job_id" />
                <div class="ftitle">
                    基础信息
                </div>
                <div class="fitem">
                    <label style="text-align:right;">
                        岗位名称：
                    </label>
                    <input class="easyui-textbox" id="job_name" required="true" missingmessage="岗位名称不能为空！"
                        style="width:120px;" />
                    <label style="text-align:right;">
                        岗位编码：
                    </label>
                    <input class="easyui-textbox" id="job_innum" style="width:120px;" />
                </div>
                <div class="fitem">
                    <label style="text-align:right;">
                        成立：
                    </label>
                    <input class="easyui-datebox" id="job_build" required="true" missingmessage="请选择成立时间！"
                        style="width:100px;" />
                </div>
                <div class="ftitle">
                    部门选择
                </div>
                <div class="fitem">
                    <label style="text-align: right;">
                        公司：
                    </label>
                    <input class="easyui-combobox" id="job_company" style="width: 120px" />
                    <label style="text-align: right;">
                        部门：
                    </label>
                    <input class="easyui-combotree" id="job_branch" required="true" missingmessage="请选择部门！" style="width:120px;"  />
                </div>
                </form>
            </div>
            <div data-options="region:'south',border:false" style="text-align: right; padding: 5px 0 0;">
                <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)"
                    onclick="saveJob();" style="width: 80px">保存</a> <a class="easyui-linkbutton"
                        data-options="iconCls:'icon-cancel'" href="javascript:void(0)" onclick="closeAddWin()"
                        style="width: 80px">取消</a>
            </div>
        </div>
    </div>
    <div id="cancleWin" class="easyui-window" title="" data-options="iconCls:'icon-save'"
        style="width: 480px; height: 240px; padding: 5px;">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'center'" style="padding: 10px;">
                <form id="Form1">
                <input type="hidden" id="cancleJobID" />
                <div class="ftitle">
                    取消信息
                </div>
                <div class="fitem">
                    <label style="text-align:right;">
                        取消时间：
                    </label>
                    <input class="easyui-datebox" id="job_close" required="true" missingmessage="请选择成立时间！"
                        style="width:100px;" />
                    
                </div>
                <div class="fitem">
                    <label style="text-align:right;">
                        取消原因：
                    </label>
                    <input class="easyui-textbox" id="job_close_reason" data-options="multiple:true" style="width: 200px;
                        height: 80px" />
                </div>
                </form>
            </div>
            <div data-options="region:'south',border:false" style="text-align: right; padding: 5px 0 0;">
                <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)"
                    onclick="saveCancle();" style="width: 80px">保存</a> <a class="easyui-linkbutton"
                        data-options="iconCls:'icon-cancel'" href="javascript:void(0)" onclick="closeCancleWin()"
                        style="width: 80px">取消</a>
            </div>
        </div>
    </div>
</body>
</html>
<script type="text/javascript">
    var selRow;
    var action;
    $(document).ready(function () {
        $('#dg').datagrid({
            url: '../../ashx/branch/jobHandler.ashx?action=grid',
            method: 'post',
            singleSelect: true,
            //collapsible: true,
            loadMsg: "正在努力加载数据，请稍后...",
            striped: true, //行背景交换
            nowap: true, //列内容多时自动折至第二行
            pagination: true, //分页控件
            pageSize: 20,
            pagePosition: 'bottom', //分页控件位置
            remoteSort: false,
            columns: [[
                { field: 'job_id', title: '岗位编号', width: 60, hidden: true },
                { field: 'job_company_id', title: '公司编号', width: 100, align: 'center', hidden: true },
                { field: 'job_company_name', title: '公司名称', width: 100, align: 'center' },
                { field: 'job_branch_id', title: '部门编号', width: 100, align: 'center', hidden: true },
                { field: 'job_branch_name', title: '部门名称', width: 100, align: 'center' },
                { field: 'job_name', title: '岗位名称', width: 100, align: 'center' },
                { field: 'job_innum', title: '岗位编码', width: 80, align: 'center' },
                { field: 'job_build', title: '成立时间', width: 100, align: 'center' },
                { field: 'job_state', title: '岗位状态', width: 100, align: 'center', formatter: jobStateFormater }
             ]],
            rownumbers: true,
            toolbar: [{
                text: '添加',
                iconCls: 'icon-add',
                handler: function () {
                    action = "add";
                    $('#addJob').window('open').window('setTitle', '添加岗位信息');
                    LoadComboData();
                }
            }, {
                text: '编辑',
                iconCls: 'icon-undo',
                handler: function () {
                    action = "edit";
                    editMsgDialog();
                }
            }, {
                text: '删除',
                iconCls: 'icon-no',
                handler: function () {
                    delMsgDialog();
                }
            },
            '-',
                {
                    text: '岗位名称：<input type="text" id="search_job_name"/>'
                }, {
                    text: '搜索',
                    iconCls: 'icon-search',
                    handler: function () {
                        doSearch();
                    }
                }],
            onSelect: function (index, row) {
                selRow = row.job_id;
            },
            onLoadSuccess: function (data) {
                for (var i = 0; i < data.rows.length; i++) {
                    if (data.rows[i].job_state == 1) {
                        var cancleTime = data.rows[i].job_close
                        var cancleReason = data.rows[i].job_close_reason;
                        toolcontent = "<tr><td>取消时间：" + cancleTime + " </td></tr>";
                        toolcontent = toolcontent + "<tr><td>取消原因：" + cancleReason + " </td></tr>";
                    }
                    if (data.rows[i].job_state == 0) {
                        toolcontent = "<tr><td><a href='javascript:void(0)' onclick='CancleJob(" + data.rows[i].job_id + ")'>取消该岗位</a></td></tr>";
                    }
                    //拼写tooltip的内容   
                    tooltipcontent = "<table style='width:200px;'>" + toolcontent + "</table>";
                    addTooltip(tooltipcontent, 'content-' + i);
                }
            }
        });
        var p = $('#dg').datagrid('getPager');
        $(p).pagination({
            pageSize: 20, //每页显示的记录条数，默认为20 
            pageList: [10, 20, 50], //可以设置每页记录条数的列表 
            beforePageText: '第', //页数文本框前显示的汉字 
            afterPageText: '页    共 {pages} 页',
            displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'
        });
        $('#addJob').window({
            modal: true,
            closed: true,
            minimizable: false,
            collapsible: true
        });
        $('#cancleWin').window({
            modal: true,
            closed: true,
            minimizable: false,
            collapsible: true
        });
    });
    var LoadComboData = function () {
        $('#job_company').combotree({
            url: '../../ashx/Company/CompanyHandler.ashx?action=combo',
            animate: true,
            onSelect: function (companyID) {
                $('#job_branch').combotree({
                    url: '../../ashx/Branch/branchHandler.ashx?action=combo&branch_parent=0&company_id=' + companyID.id,
                    animate: true,
                    onBeforeExpand: function (node) {
                        $('#job_branch').combotree("tree").tree("options").url = "../../ashx/Branch/branchHandler.ashx?action=combo&branch_parent=" + node.id + "&company_id=" + companyID.id;
                    }
                });
            }
        });
    };
    function doSearch() {
        $('#dg').datagrid('load', {
            job_name: $('#search_job_name').val()
        })
    };
    function editJob() {
        var row = $('#dg').datagrid('getSelected');
        if (row != undefined || row != null) {
            if (row.job_state != '1') {
                $('#addJob').window('open').window('setTitle', '编辑岗位信息');
                LoadComboData();
                $('#job_id').val(row.job_id);
                $('#job_innum').textbox('setValue', row.job_innum);
                $('#job_name').textbox('setValue', row.job_name);
                $('#job_build').datebox('setValue', row.job_build);
                $('#job_company').combotree('setValue', row.job_company_id);

                $('#job_branch').combotree('setValue', row.job_branch_id);
                $('#job_branch').combotree('setText', row.job_branch_name);
            }
            else {
                parent.$.messager.alert("操作提示", "当前岗位已处于取消状态！无法修改！", "提示");
            };
        };
    };

    //编辑操作提示
    function editMsgDialog() {
        if (selRow != undefined || selRow != "") {
            parent.$.messager.confirm("操作提示", "您确定要执行修改操作吗？", function (data) {
                if (data) {
                    editJob();
                }
                else {
                }
            });
        }
        else {
            parent.$.messager.alert("操作提示", "请选择要修改的数据！", "提示");
        }
    };
    function saveJob() {
        var jobInfo = {
            job_id: $('#job_id').val(),
            job_innum: $('#job_innum').textbox('getValue'),
            job_name: $('#job_name').textbox('getValue'),
            job_branch: $('#job_branch').combotree('getValue'),
            job_build:$('#job_build').datebox('getValue')
        };
        $.ajax({
            type: 'post',
            url: '../../ashx/branch/jobHandler.ashx?action='+action,
            data: jobInfo,
            dataType: 'text',
            success: function (msg) {
                if (msg == "1") {
                    parent.$.messager.alert("操作提示", "保存成功", "info");
                    closeAddWin();
                } else {
                    $.messager.showMsg("操作提示", "保存失败", "error");
                }
            }
        });      
    };
    function saveCancle() {
        var cancleInfo = {
            job_id: $('#cancleJobID').val(),
            job_close: $('#job_close').datebox('getValue'),
            job_close_reason: $('#job_close_reason').textbox('getValue')
        };
        $.ajax({
            type: 'post',
            url: '../../ashx/branch/jobHandler.ashx?action=cancle',
            data: cancleInfo,
            dataType: 'text',
            success: function (msg) {
                if (msg == "1") {
                    parent.$.messager.alert("操作提示", "保存成功", "info");
                    closeCancleWin();
                } else {
                    $.messager.showMsg("操作提示", "保存失败", "error");
                }
            }
        });
    };
    //删除操作提示
    function delMsgDialog() {
        if (selRow != undefined || selRow != "") {
            parent.$.messager.confirm("操作提示", "您确定要执行删除操作吗？", function (data) {
                if (data) {
                    delNode();
                }
                else {
                }
            });
        }
        else {
            parent.$.messager.alert("操作提示", "请选择要删除的数据！", "提示");
        }
    };
    function delNode() {
        $.ajax({
            url: '../../ashx/Branch/jobHandler.ashx?action=del',
            data: { job_id: selRow },
            type: 'post',
            dataType: 'text',
            success: function (msg) {
                if (msg == '1') {
                    parent.$.messager.alert("操作提示", "删除成功！", "info");
                    $('#dg').datagrid('reload');
                } else {
                    parent.$.messager.alert("操作提示", "删除失败！", "error");
                }
            }
        });
    };
    function closeAddWin() {
        $('#addJob').window('close');
        $('#dg').datagrid('reload');
    };
    function closeCancleWin() {
        $('#cancleJobID').window('close');
        $('#dg').datagrid('reload');
    };
    function CancleJob(jobID) {
        $('#cancleJobID').val(jobID);
        $('#cancleWin').window('open').window('setTitle',"取消岗位");
    };
</script>
