<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/color.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/demo/demo.css">
    <link rel="stylesheet" type="text/css" href="../../css/fitem.css">
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../Scripts/Common/common.js"></script>
</head>
<body>
    <table id="dg">
    </table>
    <div id="adddiretory" class="easyui-window" title="" data-options="iconCls:'icon-save'"
        style="width: 610px; height: 460px; padding: 5px;">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'center'" style="padding: 10px;">
                <form id="ff">
                <div class="ftitle">
                    目录信息<input type="hidden" id="Hidden1" /></div>
                    
                <div class="fitem">
                    <label>
                        目录名称：</label>
                    <input class="easyui-textbox" id="diretory_name" style="width: 150px;" required="true"
                        missingmessage="请输入目录名称！" />
                    <label>
                        目录编码：</label>
                    <input class="easyui-textbox" id="diretory_innum" style="width: 150px" />
                </div>
                <div class="ftitle">
                    创建信息</div>
                <div class="fitem">
                    <label>
                        创建时间：</label>
                    <input class="easyui-datetimebox" id="diretory_create_time" style="width: 150px" required="true"
                        missingmessage="请选择创建时间！" value="7/6/2016 11:11" data-options="showSeconds:false">
                    <label>
                        创建人：</label>
                    <input class="easyui-textbox" id="diretory_create_people" style="width: 150px;" />
                </div>
                <div class="ftitle">
                    相关属性</div>
                <div class="fitem">
                    <label>
                        可见：
                    </label>
                    <input id="diretory_visible" class="easyui-switchbutton" checked="checked" style="width:50px;height:20px">
                    <label>
                    通用：</label>
                    <input id="diretory_general" class="easyui-switchbutton" checked="checked" style="width:50px;height:20px">
                    <label>
                    可选：</label>
                    <input id="diretory_selectable" class="easyui-switchbutton" checked="checked" style="width:50px;height:20px">
                </div>
                <div class="fitem">
                    <label>
                        资料类型：</label>
                    <input id="fileclass_code" name="fileclass_code"  missingmessage="请选择资料类型！" class="easyui-combotree" style="width: 200px;" />
                    <label>
                        上级目录:
                    </label>
                    <input id="diretory_parent" name="diretory_parent" class="easyui-combotree"  missingmessage="请选择文件目录！" />
                </div>
                <div class="ftitle">备注</div>
                <div class="fitem">
                    <label >
                    备注说明：</label>
                    <input id="diretory_remark" class="easyui-textbox" data-options="multiline:true" style ="width:300px;height:100px">
                </div>
                </form>
            </div>
            <div data-options="region:'south',border:false" style="text-align: right; padding: 5px 0 0;">
                <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)"
                    onclick="SaveDiretoryInfo('add');" style="width: 80px">保存</a> <a class="easyui-linkbutton"
                        data-options="iconCls:'icon-cancel'" href="javascript:void(0)" onclick="closeAddWin()"
                        style="width: 80px">取消</a>
            </div>
        </div>
    </div>
</body>
</html>
<script type="text/javascript" >
    var selRow;
    $(document).ready(function () {
        $('#adddiretory').window({
            title: '添加新目录',
            striped: true,
            singleSelect: true,
            modal: true,
            closed: true,
            minimizable: false,
            collapsible: true
        });
        $('#dg').datagrid({
            url: '../../ashx/file/diretoryHandler.ashx?action=grid',
            method: 'post',
            loadMsg: "正在努力加载数据，请稍后...",
            pagination: true, //分页控件
            pageSize: 20,
            pagePosition: 'bottom', //分页控件位置
            singleSelect: true,
            remoteSort: false,
            columns: [[
                { field: 'diretory_code', title: '目录编号', width: 100, align: 'center', hidden: true },
                { field: 'diretory_name', title: '目录名称', width: 200, align: 'center', sortable: true },
                { field: 'diretory_innum', title: '目录编码', width: 100, align: 'center' },
                { field: 'diretory_create_time', title: '创建时间', width: 140, align: 'center' },
                { field: 'diretory_create_people', title: '创建人', width: 200, align: 'center' },
                { field: 'fileclass_code', title: '资料类型', width: 200, align: 'center', hidden: true },
                { field: 'fileclass_name', title: '资料类型', width: 200, align: 'center' },
                { field: 'diretory_parent_code', title: '上级目录编号', width: 200, align: 'center', hidden: true },
                { field: 'diretory_parent_name', title: '上级目录名称', width: 200, align: 'center', sortable: true },
                { field: 'diretory_visible', title: '是否可见', width: 60, align: 'center',
                    formatter: function (val, rec) {
                        if (val == 0) {
                            return '<span style="color:red;">×</span>';
                        } else {
                            return '<span style="color:green;">√</span>';
                        }
                    }
                },
                { field: 'diretory_general', title: '是否通用', width: 60, align: 'center',
                    formatter: function (val, rec) {
                        if (val == 0) {
                            return '<span style="color:red;">×</span>';
                        } else {
                            return '<span style="color:green;">√</span>';
                        }
                    }
                },
                { field: 'diretory_selectable', title: '是否可选', width: 60, align: 'center',
                    formatter: function (val, rec) {
                        if (val == 0) {
                            return '<span style="color:red;">×</span>';
                        } else {
                            return '<span style="color:green;">√</span>';
                        }
                    }
                },
                { field: 'diretory_remark', title: '备注说明', width: 200, align: 'center' }
            ]],
            toolbar: [{
                text: '添加',
                iconCls: 'icon-add',
                handler: function () {
                    loadFileClass();
                    $('#adddiretory').window('open');
                }
            }, {
                text: '删除',
                iconCls: 'icon-no',
                handler: function () {
                    delMsgDialog();
                }
            }, {
                text: '保存',
                iconCls: 'icon-save',
                handler: function () { alert('save') }
            }, '-', {
                text: '目录名称：<input id="search_diretory_name" type="text">'
            }, {
                text: '搜索',
                iconCls: 'icon-search',
                handler: function () {
                    doSearch();
                }
            }],
            onSelect: function (index, row) {
                selRow = row.diretory_code;
            }
        });
        var p = $('#dg').datagrid('getPager');
        $(p).pagination({
            pageSize: 20, //每页显示的记录条数，默认为10 
            pageList: [10, 20, 50], //可以设置每页记录条数的列表 
            beforePageText: '第', //页数文本框前显示的汉字 
            afterPageText: '页    共 {pages} 页',
            displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'
        });
    });
    function doSearch() {
        $('#dg').datagrid('load', {
            diretory_name: $('#search_diretory_name').val()
        })
    }
    function closeAddWin() {
        $('#adddiretory').window('close');
        $('#dg').datagrid('reload');
    };
    //删除操作提示
    function delMsgDialog() {
        if (selRow != undefined || selRow != "") {
            parent.$.messager.confirm("操作提示", "您确定要执行删除操作吗？", function (data) {
                if (data) {
                    delNode();
                }
                else {
                }
            });
        }
        else {
            parent.$.messager.alert("操作提示", "请选择要删除的数据！", "error");
        }
    };
    function delNode() {
        $.ajax({
            url: '../../ashx/file/diretoryHandler.ashx?action=del&diretory_code=' + selRow,
            data: null,
            type: 'post',
            dataType: 'text',
            success: function (msg) {
                if (msg == '1') {
                    parent.$.messager.alert("操作提示", "删除成功！", "info");
                    $('#dg').datagrid('reload');
                    var s = parent.$('#leftFrame2').contents().find('#refreshtree');
                    s.click();
                } else {
                    parent.$.messager.alert("操作提示", "删除失败！", "error");
                }
            }
        });
    };
    var loadFileClass = function () {
        $('#fileclass_code').combotree({
            url: '../../ashx/file/fileclassHandler.ashx?action=combo',
            animate: true,
            onBeforeExpand: function (node) {
                $('#fileclass_code').combotree("tree").tree("options").url = "../../ashx/file/fileclassHandler.ashx?action=combo&fileclass_parent=" + node.id;
            },
            onSelect: function (classnode) {
                $('#diretory_parent').combotree({
                    url: '../../ashx/file/diretoryHandler.ashx?action=combo&diretory_parent=&fileclass_code=' + classnode.id,
                    animate: true,
                    onBeforeExpand: function (node) {
                        $('#diretory_parent').combotree("tree").tree("options").url = "../../ashx/file/diretoryHandler.ashx?action=combo&diretory_parent=" + node.id + "&fileclass_code=" + classnode.id;
                    }
                });
            }
        });
    };
    var SaveDiretoryInfo = function (action) {
        var diretoryInfo = {
            diretory_code: $('#diretory_code').val(),
            diretory_name: $('#diretory_name').val(),
            diretory_innum: $('#diretory_innum').val(),
            diretory_create_time: $('#diretory_create_time').datetimebox('getValue'),
            diretory_create_people: $('#diretory_create_people').val(),
            fileclass_code: $('#fileclass_code').combotree('getValue'),
            diretory_parent: $('#diretory_parent').combotree('getValue'),
            diretory_visible: $('#diretory_visible').switchbutton('options').checked == true ? 1 : 0,
            diretory_general: $('#diretory_general').switchbutton('options').checked == true ? 1 : 0,
            diretory_selectable: $('#diretory_selectable').switchbutton('options').checked == true ? 1 : 0,
            diretory_remark: $('#diretory_remark').val()
        };

        $.ajax({
            type: 'post',
            url: '../../ashx/file/diretoryHandler.ashx?action=' + action,
            data: diretoryInfo,
            dataType: 'text',
            success: function (msg) {
                if (msg == "1") {
                    parent.$.messager.alert("操作提示", "保存成功", "info");
                    if (action == 'add') {
                        $('#dg').datagrid('reload');
                        var s = parent.$('#leftFrame2').contents().find('#refreshtree');
                        s.click();
                        $('#ff').form('clear');
                        loadFileClass();
                    };
                } else {
                    $.messager.showMsg("操作提示", "保存失败", "error");
                }
            }
        });
    };
</script>