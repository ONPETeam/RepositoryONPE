<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>资料树</title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/demo/demo.css">
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.easyui.min.js"></script>
    <script src="../../Scripts/Common/common.js" type="text/javascript"></script>
</head>
<body>
    <input type="hidden" id="refreshtree" onclick="RefreshTree()" />
    <input type="hidden" id="reloadNode" onclick="ReloadNode()" />
    <input type="hidden" id="fileselectID" />
    <input id="fileClass_code" class="easyui-combotree" style="width: 100%;" />
    <div id="loading" style="width: 200px; display: none">
        <img src="../../img/loading.gif" style="width: 16px; height: 16px;"/>
        Loading......
    </div>
    <ul id="tt" class="easyui-tree" style="padding-top: 6px">
    </ul>
</body>
</html>
<script language="javascript" type="text/javascript">
    var treenodes;
    var fileclass_code = 'PCZLLX999999000001';
    function RefreshTree() {
        loadFileTree();
    };
    function ReloadNode() {
        if (treenodes) {
            $("#tt").tree("reload", treenodes.target);
        } else {
            $("#tt").tree("options").url = '../../ashx/file/diretoryHandler.ashx?action=tree&fileclass_code=' + fileclass_code;
            $("#tt").tree("reload");
        }
    };
    var loadFileTree = function () {
        $('#tt').tree({
            checkbox: false,
            animate: true,
            url: '../../ashx/file/diretoryHandler.ashx?action=tree&fileclass_code=' + fileclass_code,
            onBeforeExpand: function (node) {
                if (node.attributes == "diretory") {
                    $('#tt').tree('options').url = "../../ashx/file/fileDiretoryHandler.ashx?action=tree&diretory_parent=" + node.id + "&fileclass_code=" + fileclass_code;
                }
//                if (node.attributes == "lastdiretory") {
//                    $('#tt').tree('options').url = "../../ashx/file/fileHandler.ashx?action=tree&diretory_code=" + node.id + "&fileclass_code=" + fileclass_code;
//                }
            },
            onSelect: function (node) {
                $('#tt').tree(node.state === 'closed' ? 'expand' : 'collapse', node.target);
                treenodes = $('#tt').tree("getParent", node.target);
                if (node.attributes == "diretory" || node.attributes == "lastdiretory") {
                    parent.LoadPropertyData("ashx/file/diretoryHandler.ashx?action=prop&diretory_code=" + node.id, "diretory");
                    parent.$("#propid").val(node.id);
                };
                if (node.attributes == "file") {
                    parent.LoadPropertyData("ashx/file/fileHandler.ashx?action=prop&file_code=" + node.id, "file");
                    $('#fileselectID').val(node.id);

                    parent.$("#propid").val(node.id);

                    var currentPageTitle = getCurrentPageTitle();

                    if (currentPageTitle == '资料预览') {
                        window.parent.refreshTab({tabTitle:'',url:''});
                    }
                    if (currentPageTitle == "设备图纸") {
                        var object1 = parent.$('#mainFrame' + currentPageTitle).contents().find('#getValueAndRefresh');
                        object1.val(node.id);
                        object1.click();
                    }
                };
            }
        });
    };
    $(document).ready(function () {
        $('#fileClass_code').combotree({
            url: '../../ashx/file/fileclassHandler.ashx?action=combo',
            animate: true,
            onBeforeExpand: function (node) {
                $('#fileClass_code').combotree("tree").tree("options").url = "../../ashx/file/fileclassHandler.ashx?action=combo&fileclass_parent=" + node.id;
            },
            onSelect: function (classnode) {
                fileclass_code = classnode.id;
                loadFileTree();
            }
        });
    });
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg); //匹配目标参数
        if (r != null) return unescape(r[2]); return null; //返回参数值
    }
</script>
