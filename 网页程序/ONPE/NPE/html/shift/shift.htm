<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/color.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/demo/demo.css">
    <link rel="stylesheet" type="text/css" href="../../css/fitem.css">
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.easyui.min.js"></script>
    <script src="../../Scripts/EasyUI/datagrid-detailview.js" type="text/javascript"></script>
    <script src="../../Scripts/EasyUI/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script type="text/javascript" src="../../Scripts/Common/common.js"></script>
    <script src="../../Scripts/JSCookies.js" type="text/javascript"></script>
    
</head>
<body>
    <table id="dg"></table>
    <div id="win" class="easyui-window" title="" data-options="iconCls:'icon-save',cache: false" style="width: 600px; height: 740px; padding: 5px;">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'center'" style="padding: 10px;">
                <form id="tt">
                    <div class="ftitle">基础信息</div>
                    <input type="hidden" id="shife_code" />
                    <div class="fitem">
                        <label style="width:40px;text-align:right">
                            日期：
                        </label>
                        <input id="shift_date" class="easyui-textbox" readonly="readonly" style="width:100px;" />
                        <label style="width:40px;text-align:right">
                            部门：
                        </label>
                        <input id="branch_name" class="easyui-textbox" readonly="readonly" style="width:120px;" />
                        <input id="branch_id" type="hidden"/>
                        <label style="width:40px;text-align:right">
                            班次：
                        </label>
                        <input id="classnum_name" class="easyui-textbox" readonly="readonly" style="width:70px;" />
                        <input id="classnum_code" type="hidden" />
                        <label style="width:40px;text-align:right">
                            班别：
                        </label>
                        <input id="classtype_name" class="easyui-textbox" readonly="readonly" style="width:70px;" />
                        <input id="classtype_code" type="hidden" />
                    </div>
                    <div class="ftitle">本班处理项目</div>
                    <div class="fitem">
                        <table id="showRecord"></table>
                    </div>
                    <div class="ftitle">本班工作总结</div>
                    <div class="fitem">
                        <input id="work_context" class="easyui-textbox" data-options="multiline:true" style="width:550px;height:100px;" />
                    </div>
                    <div class="ftitle">设备缺陷与工具仪表</div>
                    <div class="fitem">
                        <label style="width:60px;text-align:right; vertical-align:middle;">
                            设备缺陷：
                        </label>
                        <input id="mater_defect" class="easyui-textbox" data-options="multiline:true" style="width:200px;height:40px;" />
                        <label style="width:60px;text-align:right;vertical-align:middle;">
                            工具仪表：
                        </label>
                        <input id="shift_instrument" class="easyui-textbox" data-options="multiline:true" style="width:200px;height:40px;" />
                    </div>
                    <div class="ftitle">交接班人员</div>
                    <div class="fitem">
                        <label style="width:60px;text-align:right;vertical-align:middle;">
                            交班人员：
                        </label>
                        <input id="shift_jiaoban" class="easyui-combotree" data-options="multiple:true" required="true" missingmessage="请选择交班人员！"
                                style="width:200px" />
                        <label style="width:60px;text-align:right;vertical-align:middle;">
                            接班人员：
                        </label>
                        <input id="shift_jieban" class="easyui-combotree" data-options="multiple:true" required="true" missingmessage="请选择交班人员！"
                                style="width:200px" />
                    </div>
                </form>
            </div>
            <div id="ss" data-options="region:'south',border:false" style="text-align: right; padding: 5px 0 0;">
                <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)"
                    onclick="SaveShiftInfo();" style="width: 80px">保存</a> <a class="easyui-linkbutton"
                        data-options="iconCls:'icon-cancel'" href="javascript:void(0)" onclick="closeShiftWin()"
                        style="width: 80px">取消</a>
            </div>
        </div>
    </div>
</body>
</html>
<script type="text/javascript">
    var selRow;
    $(document).ready(function () {
        $('#dg').datagrid({
            url: '../../ashx/shift/shiftHandler.ashx?action=grid',
            method: 'post',
            loadMsg: "正在努力加载数据，请稍后...",
            pagination: true, //分页控件
            pageSize: 20,
            pagePosition: 'bottom', //分页控件位置
            singleSelect: true,
            rownumbers: true,
            remoteSort: false,
            fit: true,
            frozenColumns: [[
                                { title: '基础信息', colspan: 10 }
                            ], [
                                { field: 'shift_code', title: '交接班编号', hidden: 'true' },
                                { field: 'shift_date', title: '日期', width: 100, align: 'center',sortable:true },
                                { field: 'branch_id', title: '部门编号', hidden: 'true' },
                                { field: 'branch_name', title: '部门名称', width: 100, align: 'center', sortable: true },
                                { field: 'classnum_code', title: '班次编号', hidden: 'true' },
                                { field: 'classnum_name', title: '班次', width: 50, align: 'center' },
                                { field: 'classtype_code', title: '班别编号', hidden: 'true' },
                                { field: 'classtype_name', title: '班别', width: 50, align: 'center' },
                            ]],
            columns: [[
                        { title: '工作内容', colspan: 5 },
                        { title: '交接班状况', colspan: 6 },
                        { title: '工作记录', field: 'shift_record', width: 120, align: 'center', rowspan: 2 }
                    ], [
                        { field: 'effect_time', title: '影响台时', hidden: 'true' },
                        { field: 'run_state', title: '运行状态', hidden: 'true' },
                        { field: 'work_context', title: '工作总结', width: 100, align: 'center', formatter: remarkFormater },
                        { field: 'mater_defect', title: '设备缺陷', width: 100, align: 'center' },
                        { field: 'instrument_state', title: '工具仪表', width: 100, align: 'center' },

                        { field: 'hand_peop_id', title: '交班人员编号', hidden: 'true' },
                        { field: 'hand_peop_name', title: '交班人员', width: 120, align: 'center' },
                        { field: 'hand_time', title: '交班时间', width: 60, align: 'center' },

                        { field: 'duty_peop_id', title: '接班人员编号', hidden: 'true' },
                        { field: 'duty_peop_name', title: '接班人员', width: 120, align: 'center' },
                        { field: 'duty_time', title: '接班时间', width: 60, align: 'center' }
                    ]],
            toolbar: [{
                text: '查看详细',
                iconCls: 'icon-add',
                handler: function () {
                    var row = $('#dg').datagrid('getSelected');
                    lookShift(row, 'look');
                }
            }, {
                text: '修改记录',
                iconCls: 'icon-cut',
                handler: function () {
                    var row = $('#dg').datagrid('getSelected');
                    lookShift(row, 'edit');
                }
            },
            '-', {
                text: '记录日期：<input id="search_shift_date" >'
            }, {
                text: '部门名称：<input id="search_branch_id">'
            }, {
                text: '搜索',
                iconCls: 'icon-search',
                handler: function () {

                }
            }],
            onSelect: function (index, row) {
                selRow = row.equip_code;
            },
            onLoadSuccess: function (data) {
                for (var i = 0; i < data.rows.length; i++) {
                    if (data.rows[i].work_context != undefined) {
                        var content = data.rows[i].work_context;
                        toolcontent = "<tr><td>具体内容：" + content + " </td></tr>";
                    }
                    toolTipContent = "<table style='width:200px;'>" + toolcontent + "</table>";
                    addTooltip(toolTipContent, 'content-' + i);
                }
            },
            onDblClickRow: function (rowIndex, rowData) {
                lookShift(rowData, 'look');
            }
        });
        var p = $('#dg').datagrid('getPager');
        $(p).pagination({
            pageSize: 20, //每页显示的记录条数，默认为20 
            pageList: [10, 20, 50], //可以设置每页记录条数的列表 
            beforePageText: '第', //页数文本框前显示的汉字 
            afterPageText: '页    共 {pages} 页',
            displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'
        });
        $('#win').window({
            title: '管理交接班记录',
            striped: true,
            singleSelect: true,
            modal: true,
            closed: true,
            minimizable: false,
            collapsible: true
        });
    });
    function loadCombo(branchID) {
        $('#shift_jiaoban').combotree({
            url: '../../ashx/employee/employeeHandler.ashx?action=combo&branch_id=' + branchID,
            animate: true
        });
        $('#shift_jieban').combotree({
            url: '../../ashx/employee/employeeHandler.ashx?action=combo&branch_id=' + branchID,
            animate: true
        });
    };
    function closeShiftWin() {
        $('#win').window('close');
    };
    function lookShift(shiftData, action) {
        var readOnlyFlag = false;
        $('#tt').form('clear');

        $('#showRecord').datagrid({
            url: '../../ashx/shift/workContextHandler.ashx?action=get',
            method: 'post',
            queryParams: {
                branch_id: shiftData.branch_name,
                work_date:shiftData.shift_date,
                classnum_code: shiftData.classnum_code
            },
            singleSelect: true,
            collapsible: true,
            loadMsg: "正在努力加载数据，请稍后...",
            pagination: true, //分页控件
            pageSize: 20,
            pagePosition: 'bottom', //分页控件位置
            width: 550,
            height: 250,
            rownumbers:true,
            frozenColumns: [[
                { field: 'dVchWorkNote', title: '工作票号', hidden: true },
                { field: 'dVchWorkCreatUnit', title: '签发单位', width: 80, align: 'center' },
                { field: 'dVchWorkCreatPeo', title: '签发人', width: 60, align: 'center' },
                { field: 'dDaeWorkSys', title: '签发时间', width: 80, align: 'center' }
                ]],
            columns: [[
                { field: 'dVchFromType', title: '工作来源', width: 100, align: 'center' },
                { field: 'dVchActionDep', title: '作业部门', width: 100, align: 'center' },
                { field: 'dVchArea', title: '作业区域', width: 110, align: 'center' },
                { field: 'dDaeWorkStart', title: '作业开始时间', width: 130, align: 'center' },
                { field: 'dVchWorkPeo', title: '作业负责人', width: 80, align: 'center' },
                { field: 'dVchWorkPeoQZ', title: '岗位签字', width: 80, align: 'center' },
                { field: 'dDaeWorkEnd', title: '作业结束时间', width: 130, align: 'center' },
                { field: 'dVchWorkPeo1', title: '作业负责人', width: 80, align: 'center' },
                { field: 'dVchWorkPeoQZ1', title: '岗位签字', width: 80, align: 'center' }
            ]],
            view: detailview,
            detailFormatter: function (index, row) {
                return '<div style="padding:2px"><table id="ddv-' + index + '"></table></div>';
            },

            onExpandRow: function (index, row) {
                $('#ddv-' + index).datagrid({
                    url: '../../ashx/rwxt/gzpHandler.ashx?type=item&gzpid=' + row.dVchWorkNote,
                    method: 'post',
                    singleSelect: true,
                    collapsible: true,
                    rownumbers: true,
                    columns: [[
                        { field: 'equip_code', title: '设备名称', width: 100, align: 'center', hidden: 'true' },
                        { field: 'equip_name', title: '设备名称', width: 130, align: 'center', editor: "textbox" },
                        { field: 'dVchWorkContent', title: '作业内容', width: 218, align: 'center' },
                        { field: 'dVchIsClose', title: '是否停电', width: 80, align: 'center' },
                        { field: 'dVchApplyPeo', title: '申请人', width: 80, align: 'center' },
                        { field: 'dVchZKCheckPeo', title: '中控', width: 80, align: 'center', editor: "textbox" },
                        { field: 'dVchActionPeo', title: '执行人', width: 80, align: 'center', editor: "textbox" }
                    ]],
                    onResize: function () {
                        $('#showRecord').datagrid('fixDetailRowHeight', index);
                    },
                    onLoadSuccess: function () {
                        setTimeout(function () {
                            $('#showRecord').datagrid('fixDetailRowHeight', index);
                        });
                    }
                });
                $('#showRecord').datagrid('fixDetailRowHeight', index);
            }
        });
        var p = $('#showRecord').datagrid('getPager');
        $(p).pagination({
            pageSize: 20, //每页显示的记录条数，默认为20 
            pageList: [10, 20, 50], //可以设置每页记录条数的列表 
            beforePageText: '第', //页数文本框前显示的汉字 
            afterPageText: '页    共 {pages} 页',
            displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'
        });

        

        $('#shife_code').val(shiftData.shift_code);
        $('#shift_date').textbox('setText', shiftData.shift_date);
        $('#branch_name').textbox('setText', shiftData.branch_name);
        $('#branch_id').val(shiftData.branch_id);
        $('#classnum_name').textbox('setText', shiftData.classnum_name);
        $('#classnum_code').val(shiftData.classnum_code);
        $('#classtype_name').textbox('setText', shiftData.classtype_name);
        $('#classtype_code').val(shiftData.classtype_code);
        loadCombo(shiftData.branch_id);
        $('#work_context').textbox('setText', shiftData.work_context);
        $('#mater_defect').textbox('setText', shiftData.mater_defect);
        $('#shift_instrument').textbox('setText', shiftData.instrument_state);
        $('#shift_jiaoban').combotree('setValues', shiftData.hand_peop_id );
        $('#shift_jieban').combotree('setValues', shiftData.duty_peop_id);
        
        switch (action) {
            case 'look':
                readOnlyFlag = true;
                document.getElementById('ss').style.display = 'none';
                $('#win').window('open').window('setTitle', '查看交接班记录详情');
                break;
            case 'edit':
                readOnlyFlag = false;
                document.getElementById('ss').style.display = '';
                $('#win').window('open').window('setTitle', '编辑交接班记录详情');
                break;
        }
        $('#work_context').textbox('readonly', readOnlyFlag);
        $('#mater_defect').textbox('readonly', readOnlyFlag);
        $('#shift_instrument').textbox('readonly', readOnlyFlag);
        $('#shift_jiaoban').combotree('readonly', readOnlyFlag);
        $('#shift_jieban').combotree('readonly', readOnlyFlag);

    };
    function SaveShiftInfo() {
        var shiftInfo = {
            shift_code: $('#shife_code').val(),
            work_context: $('#work_context').textbox('getText'),
            mater_defect: $('#mater_defect').textbox('getText'),
            instrument_state: $('#shift_instrument').textbox('getText'),
            hand_over: $('#shift_jiaoban').combotree('getValues').join(','),
            //备注说明：
            //getValues是获取多个选择项的value 
            //getValues返回值是array
            //.join(',')将返回值array转化为string
            duty_peop: $('#shift_jieban').combotree('getValues').join(',')
        };
        $.ajax({
            type: 'post',
            url: '../../ashx/shift/shiftHandler.ashx?action=edit',
            data: shiftInfo,
            dataType: 'text',
            success: function (msg) {
                if (msg == "1") {
                    $.messager.alert("操作提示", "记录修改成功！", 'info');
                }
                else {
                    $.messager.alert("操作提示", "记录修改失败！", 'info');
                    $('#win').window('close');
                }
                $('#dg').datagrid('reload');
            }
        });
    };
</script>