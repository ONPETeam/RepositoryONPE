<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/color.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/demo/demo.css">
    <link rel="stylesheet" type="text/css" href="../../css/fitem.css">
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../Scripts/Common/common.js"></script>
</head>
<body>
    <table id="dg" class="easyui-datagrid" data-options="fit:true">
    </table>
    <div id="addequip" class="easyui-window" title="" data-options="iconCls:'icon-save'"
        style="width: 610px; height: 500px; padding: 5px;">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'center'" style="padding: 10px;">
                <form id="ff">
                <div class="ftitle">
                    基础属性<input type="hidden" id="equip_code" />
                </div>
                <div class="fitem">
                    <label>
                        设备名称：</label>
                    <input id="equip_name" class="easyui-textbox" required="true" missingmessage="设备名称不能为空"
                        style="width: 100px;" />
                    <label>
                        设备编码：</label>
                    <input id="equip_innum" class="easyui-textbox" />
                </div>
                <div class="fitem">
                    <label>
                        设备符号：</label>
                    <input id="equip_mark" class="easyui-textbox" style="width: 100px;" />
                    <label>
                        规格型号：</label>
                    <input id="equip_type" class="easyui-textbox" style="width: 200px;" />
                </div>
                <div class="ftitle">
                </div>
                <div class="fitem">
                    <label>
                        所属区域：</label>
                    <input id="area_id" class="easyui-combotree" style="width: 180px;" required="true"
                        missingmessage="所属区域不能为空" value="0" />
                    <label>
                        上级设备：</label>
                    <input id="equip_parent" class="easyui-combotree" style="width: 180px;" />
                </div>
                <div class="fitem">
                    <label>
                        主管部门：</label>
                    <input id="equip_manage_company" class="easyui-combotree" style="width: 150px;" />
                    <input id="equip_manageDep" class="easyui-combotree" style="width: 150px;" required="true"
                        missingmessage="请选择主管部门" />
                </div>
                <div class="fitem">
                    <label>
                        维护部门：</label>
                    <input id="equip_check_company" class="easyui-combotree" style="width: 150px;" />
                    <input id="equip_checkDep" class="easyui-combotree" style="width: 150px;" required="true"
                        missingmessage="请选择主管部门" />
                </div>
                <div class="fitem">
                    <label>
                        负责人：</label>
                    <input id="equip_header" class="easyui-textbox" style="width: 80px;" />
                </div>
                <div class="ftitle">
                    备注</div>
                <div class="fitem">
                    <label>
                        备注说明：</label>
                    <input class="easyui-textbox" id="equip_remark" data-options="multiline:true" style="width: 540px;
                        height: 100px" />
                </div>
                </form>
            </div>
            <div data-options="region:'south',border:false" style="text-align: right; padding: 5px 0 0;">
                <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)"
                    onclick="SaveEquipInfo();" style="width: 80px">保存</a> <a class="easyui-linkbutton"
                        data-options="iconCls:'icon-cancel'" href="javascript:void(0)" onclick="closeAddWin()"
                        style="width: 80px">取消</a>
            </div>
        </div>
    </div>
    <div id="tb" class="easyui-toolbar">
        <table style="width: 100%; border: 1">
            <tr>
                <td>
                    <table>
                        <tr>
                            <td>
                                <a class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" href="javascript:void(0)"
                                    onclick="ShowAdd()">添加</a>
                            </td>
                            <td>
                                <a class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true" href="javascript:void(0)"
                                    onclick="ShowEdit()">编辑</a>
                            </td>
                            <td>
                                <a class="easyui-linkbutton" data-options="iconCls:'icon-no',plain:true" href="javascript:void(0)"
                                    onclick="ShowDel()">删除</a>
                            </td>
                            <td>
                                <span class="datagrid-btn-separator" style="vertical-align: middle; height: 15px;
                                    display: inline-block; float: none"></span>
                            </td>
                            <td>
                                自编码：
                            </td>
                            <td>
                                <input class="easyui-textbox" id="search_equip_innum" />
                            </td>
                            <td>
                                设备名称：
                            </td>
                            <td>
                                <input class="easyui-textbox" id="search_equip_name" />
                            </td>
                            <td>
                                <a class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true" href="javascript:void(0)"
                                    onclick="reloadDatagrid()">查询</a>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>
</body>
</html>
<script type="text/javascript">
    var action = "add";
    var loadComboData = function () {
        $('#area_id').combotree({
            url: '../../ashx/sbgl/areaHandler.ashx?action=combo&area_parent=0',
            animate: true,
            onBeforeExpand: function (node) {
                $('#area_id').combotree("tree").tree("options").url = "../../ashx/sbgl/areaHandler.ashx?action=combo&area_parent=" + node.id;
            },
            onSelect: function (areanode) {
                $('#equip_parent').combotree({
                    url: '../../ashx/sbgl/equipHandler.ashx?action=combo&area_id=' + areanode.id,
                    animate: true,
                    onBeforeExpand: function (node) {
                        $('#equip_parent').combotree("tree").tree("options").url = "../../ashx/sbgl/equipHandler.ashx?action=combo&equip_parent=" + node.id + '&area_id=' + areanode.id;
                    }
                });
            }
        });
    }
    function loadCompanyBranch() {
        $('#equip_manage_company').combotree({
            url: '../../ashx/Company/CompanyHandler.ashx?action=combo',
            animate: true,
            onSelect: function (companyNode) {
                $('#equip_manageDep').combotree({
                    url: '../../ashx/Branch/branchHandler.ashx?action=combo&branch_parent=0&company_id=' + companyNode.id,
                    animate: true,
                    onBeforeExpand: function (node) {
                        $('#equip_manageDep').combotree("tree").tree("options").url = '../../ashx/Branch/branchHandler.ashx?action=combo&branch_parent=' + node.id + '&company_id=' + companyNode.id;
                    }
                });
            }
        });
        $('#equip_check_company').combotree({
            url: '../../ashx/Company/CompanyHandler.ashx?action=combo',
            animate: true,
            onSelect: function (companyNode) {
                $('#equip_checkDep').combotree({
                    url: '../../ashx/Branch/branchHandler.ashx?action=combo&branch_parent=0&company_id=' + companyNode.id,
                    animate: true,
                    onBeforeExpand: function (node) {
                        $('#equip_checkDep').combotree("tree").tree("options").url = '../../ashx/Branch/branchHandler.ashx?action=combo&branch_parent=' + node.id + '&company_id=' + companyNode.id;
                    }
                });
            }
        });
    }
    $(document).ready(function () {
        $('#dg').datagrid({
            url: '../../ashx/sbgl/equipHandler.ashx?action=grid',
            method: 'post',
            loadMsg: "正在努力加载数据，请稍后...",
            pagination: true, //分页控件
            pageSize: 20,
            pagePosition: 'bottom', //分页控件位置
            singleSelect: true,
            columns: [[
                { field: 'equip_code', title: '设备编码', hidden: true },
                { field: 'equip_innum', title: '自编码', width: 200 },
                { field: 'equip_name', title: '设备名称', width: 100 },
                { field: 'equip_mark', title: '设备符号', width: 100 },
                { field: 'equip_type', title: '规格型号', width: 200 },
                { field: 'area_id', title: '所属区域', hidden: true },
                { field: 'area_name', title: '所属区域', width: 200 },
                { field: 'equip_parent', title: '上级设备', hidden: true },
                { field: 'equip_parent_name', title: '上级设备', width: 200 },
                { field: 'equip_manage_company', title: '主管公司', hidden: true },
                { field: 'equip_manage_company_name', title: '主管公司', width: 200 },
                { field: 'equip_manageDep', title: '主管部门', hidden: true },
                { field: 'equip_manageDep_name', title: '主管部门', width: 200 },
                { field: 'equip_check_company', title: '维护公司', hidden: true },
                { field: 'equip_check_company_name', title: '维护公司', width: 200 },
                { field: 'equip_checkDep', title: '维护部门', hidden: true },
                { field: 'equip_checkDep_name', title: '维护部门', width: 200 },
                { field: 'equip_header', title: '负责人', width: 200 },
                { field: 'equip_remark', title: '备注', width: 200 }

            ]],
            toolbar: '#tb'
        });
        var p = $('#dg').datagrid('getPager');
        $(p).pagination({
            pageSize: 20, //每页显示的记录条数，默认为10 
            pageList: [10, 20, 50], //可以设置每页记录条数的列表 
            beforePageText: '第', //页数文本框前显示的汉字 
            afterPageText: '页    共 {pages} 页',
            displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'
        });
        $('#addequip').window({
            title: '添加新设备',
            striped: true,
            singleSelect: true,
            modal: true,
            closed: true,
            minimizable: false,
            collapsible: true
        });
    });
    function ShowAdd() {
        action = "add";
        loadComboData();
        loadCompanyBranch();
        $('#addequip').window('open');

    };
    function ShowEdit() {
        action = "edit";
        var row = $('#dg').datagrid('getSelected');
        if (row != undefined || row != "") {
            $.messager.confirm("操作提示", "您确定要编辑当前选择的数据吗？", function (data) {
                if (data) {
                    loadCompanyBranch();
                    $('#equip_code').val(row.equip_code.toString());
                    $('#equip_innum').textbox('setValue', row.equip_innum.toString());
                    $('#equip_name').textbox('setValue', row.equip_name.toString());
                    $('#equip_mark').textbox('setValue', row.equip_mark.toString());
                    $('#equip_type').textbox('setValue', row.equip_type.toString());
                    $('#area_id').combotree('setValue', row.area_id.toString()).combotree('setText', row.area_name.toString()).combotree('disable', true);
                    $('#equip_parent').combotree('setValue', row.equip_parent.toString()).combotree('setText', row.equip_parent_name.toString()).combotree('disable', true);
                    $('#equip_manage_company').combotree('setValue', row.equip_manage_company.toString()).combotree('setText', row.equip_manage_company_name.toString()).combotree('disable', true);
                    $('#equip_manageDep').combotree('setValue', row.equip_manageDep.toString()).combotree('setText', row.equip_manageDep_name.toString()).combotree('disable', true);
                    $('#equip_check_company').combotree('setValue', row.equip_check_company.toString()).combotree('setText', row.equip_check_company_name.toString()).combotree('disable', true);
                    $('#equip_checkDep').combotree('setValue', row.equip_checkDep_name.toString()).combotree('setText', row.equip_checkDep_name.toString()).combotree('disable', true);
                    $('#equip_header').textbox('setValue', row.equip_header.toString());
                    $('#equip_remark').textbox('setValue', row.equip_remark.toString());
                    $('#addequip').window('open');
                }
            });
        }
        else {
            parent.$.messager.alert("操作提示", "请选择要编辑的数据！", "error");
        }
    };
    //删除操作提示
    function ShowDel() {
        var row = $('#dg').datagrid('getSelected');
        if (row != undefined || row != "") {
            parent.$.messager.confirm("操作提示", "删除操作将删除该设备及其所有子设备，您确定要执行删除操作吗？", function (data) {
                if (data) {
                    delNode(row.equip_code);
                }
                else {
                }
            });
        }
        else {
            parent.$.messager.alert("操作提示", "请选择要删除的数据！", "error");
        }
    };
    function delNode(equipCode) {
        $.ajax({
            url: '../../ashx/sbgl/equipHandler.ashx?action=del&equip_code=' + equipCode,
            data: null,
            type: 'post',
            dataType: 'text',
            success: function (msg) {
                var result = eval('(' + msg + ')');
                if (result.success == true) {
                    showMsg("操作提示", "删除成功！", "info");
                    $('#dg').datagrid('reload');
                    var s = parent.$('#leftFrame1').contents().find('#refreshtree');
                    s.click();
                } else {
                    showMsg("操作提示", result.msg, "error")
                }
            }
        });
    };
    function SaveEquipInfo() {
        var equipInfo = {
            equip_code: $('#equip_code').val(),
            equip_innum: $('#equip_innum').textbox('getValue'),
            equip_name: $('#equip_name').textbox('getValue'),
            equip_mark: $('#equip_mark').textbox('getValue'),
            equip_type: $('#equip_type').textbox('getValue'),
            equip_parent: $('#equip_parent').combotree('getValue'),
            area_id: $('#area_id').combotree('getValue'),
            equip_manageDep: $('#equip_manageDep').combotree('getValue'),
            equip_checkDep: $('#equip_checkDep').combotree('getValue'),
            equip_header: $('#equip_header').textbox('getValue'),
            equip_remark: $('#equip_remark').textbox('getValue')
        };

        $.ajax({
            type: 'post',
            url: '../../ashx/sbgl/equipHandler.ashx?action=' + action,
            data: equipInfo,
            dataType: 'text',
            success: function (msg) {
                var result = eval('(' + msg + ')');
                if (result.success == true) {
                    showMsg("操作提示", "保存成功", "info");
                    $('#dg').datagrid('reload');
                    var s = parent.$('#leftFrame1').contents().find('#refreshtree');
                    s.click();
                    $('#ff').form('clear');
                    loadComboData();
                    loadCompanyBranch();
                } else {
                    showMsg("操作提示", "保存失败", "error");
                }
            }
        });
    };
    function closeAddWin() {
        $('#addequip').window('close');
        $('#dg').datagrid('reload');
    }
    function reloadDatagrid() {
        $('#dg').datagrid('reload', {
            equip_innum: $('#search_equip_innum').textbox('getValue'),
            equip_name: $('#search_equip_name').textbox('getValue')
        });
    }
</script>
