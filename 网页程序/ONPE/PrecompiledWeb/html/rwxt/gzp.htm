<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/themes/color.css">
    <link rel="stylesheet" type="text/css" href="../../Scripts/EasyUI/demo/demo.css">
    <link rel="stylesheet" type="text/css" href="../../css/fitem.css">
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/EasyUI/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../Scripts/Common/common.js"></script>
    <script type="text/javascript" src="../../Scripts/Common/json.js"></script>
</head>
<body>
    
    <table id="dg" style="width:100%; height:550px"></table>
    <div id="win"  class="easyui-window" title="" data-options="iconCls:'icon-save'" style="height:410px; width:970px;padding:5px;">
        <div class="easyui-layout" data-options="fit:true">
            
            <div data-options="region:'east',split:true" style="width:220px">
                <iframe id="gzpTreeFrame" src="../sbgl/onlytree.htm" width="100%" height="300px" marginwidth="0px" marginheight="0px" frameborder="0" ></iframe>
                <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" onclick="selEquip();" style="width:110px">确定选择设备</a>
            </div>
            <div data-options="region:'center'" style="padding:10px;" >
                <div class="ftitle">新增工作票&nbsp;&nbsp;<input id="gzp" type="text" class="easyui-textbox" size="20" value="------" /><input id="equipId" value="" type="hidden"/><label>&nbsp;&nbsp;工作来源&nbsp;&nbsp;</label><input id="FromType" class="easyui-combobox" /></div>
                        <form id="ff">
                                <div class="fitem">
                                    <label>签发单位:</label><input id="WorkCreatUnit" value="" class="easyui-combotree">
                                    <label>签发人:</label><input style="width:125px" id="WorkCreatPeo" class="easyui-textbox" />
                                    <label>时间:</label><input style="width:125px" id="WorkSys" class="easyui-datetimebox" required data-options="validType:'md[\'10/11/2012\']'"/>
                                </div>
                                <div class="ftitle"></div>
                                <div class="fitem">
                                    <label>作业部门:</label><input id="ActionDep" value="" class="easyui-combotree">
                                    <label>作业区域:</label><input id="Area" value="" class="easyui-combotree" multiple >
                                    
                                </div>
                                <div class="ftitle"></div>
                                <div class="fitem">    
                                    <table id="tdEquip" style="width:100%; height:160px"></table>
                                </div>
<!--                                <div class="ftitle"></div>
                                <div class="fitem">
                                    <label>作业开始时间:</label><input style="width:125px" id="WorkStart" class="easyui-datetimebox" required data-options="validType:'md[\'10/11/2012\']'"/>
                                    <label>作业负责人:</label><input style="width:125px" id="WorkPeo" class="easyui-textbox" style="width:100px"/>
                                    <label>岗位签字:</label><input style="width:125px" id="WorkPeoQZ" class="easyui-textbox" style="width:100px"/>
                                </div>
                                <div class="ftitle"></div>
                                <div class="fitem">
                                    <label>作业结束时间:</label><input style="width:125px" id="WorkEnd" class="easyui-datetimebox" required data-options="validType:'md[\'10/11/2012\']'"/>
                                    <label>作业负责人:</label><input style="width:125px" id="WorkPeo1" class="easyui-textbox" style="width:100px"/>
                                    <label>岗位签字:</label><input style="width:125px" id="WorkPeoQZ1" class="easyui-textbox" style="width:100px"/>
                                </div>-->
                        </form>
                   </div>  
   
                <div data-options="region:'south',border:false" style="text-align:right;padding:5px 0 0;">
                    <a class="easyui-linkbutton" data-options="iconCls:'icon-ok'" href="javascript:void(0)" onclick="add();" style="width:80px">Ok</a>
                    <a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)" onclick="closeWin();" style="width:80px">Cancel</a>
                </div>
          </div>
        </div>
    <div id="qzWin" class="easyui-window" title="签字确认" style="width:300px;height:128px;padding:5px;">   
        <div class="easyui-layout" data-options="fit:true">
		    <div data-options="region:'center'" style="padding:10px;" >
                请输入姓名：<input style="width:150px;" id="qzName" class="easyui-textbox" />
            </div>
		    <div data-options="region:'south',border:false" style="text-align:right;padding:5px 0 0;">
			    <a href="#" class="easyui-linkbutton" icon="icon-ok" onclick="update();">Ok</a>
			    <a href="#" class="easyui-linkbutton" icon="icon-cancel" onclick="closeqzWin();">Cancel</a>
		    </div>
        </div>    
    </div>
    <div id="winItem" class="easyui-window" title="作业内容" style="width:760px;height:380px;padding:5px;">   
        <div class="easyui-layout" data-options="fit:true">
		    <div data-options="region:'center'" style="padding:10px;" >
                <div class="ftitle">工作票：<input id="gzpId" type="text" class="easyui-textbox" size="20" value="------" /></div>
                <table id="tdEquipContent" style="width:99%; height:260px"></table>
            </div>
        </div>    
    </div>
    <div id="timeWin" class="easyui-window" title="时间确认" style="width:300px;height:128px;padding:5px;">   
        <div class="easyui-layout" data-options="fit:true">
		    <div data-options="region:'center'" style="padding:10px;" >
                请输入时间：<input style="width:155px" id="time" class="easyui-datetimebox" required data-options="validType:'md[\'10/11/2012\']'"/>
            </div>
		    <div data-options="region:'south',border:false" style="text-align:right;padding:5px 0 0;">
			    <a href="#" class="easyui-linkbutton" icon="icon-ok" onclick="update();">Ok</a>
			    <a href="#" class="easyui-linkbutton" icon="icon-cancel" onclick="closetimeWin();">Cancel</a>
		    </div>
        </div>    
    </div>

</body>
</html>
<script type="text/javascript">
    var selRow;
    var gzpId;
    var qzMark=0;

    var gzpItem;
    var effectRow;

    var effectRow1;
    var editIndex = undefined;
    $.extend($.fn.validatebox.defaults.rules, {
        md: {
            validator: function (value, param) {
                var d1 = $.fn.datebox.defaults.parser(param[0]);
                var d2 = $.fn.datebox.defaults.parser(value);
                return d2 <= d1;
            },
            message: '日期格式不正确，例如 {0}.'
        }
    })
    $(function () {
        getUnitData();
        $('#dg').datagrid({
            url: '../../ashx/rwxt/gzpHandler.ashx?type=grid',
            method: 'post',
            singleSelect: true,
            collapsible: true,
            loadMsg: "正在努力加载数据，请稍后...",
            pagination: true, //分页控件
            pageSize: 20,
            pagePosition: 'bottom', //分页控件位置
            fit:true,
            frozenColumns: [[
                { field: 'dVchWorkNote', title: '工作票号', width: 100, align: 'center' },
                { field: 'dVchWorkCreatUnit', title: '签发单位', width: 100, align: 'center' },
                { field: 'dVchWorkCreatPeo', title: '签发人', width: 80, align: 'center' },
                { field: 'dDaeWorkSys', title: '签发时间', width: 130, align: 'center' },
                { field: 'Item', title: '作业项目', width: 90, align: 'center', formatter: strFormatWorkItem }
                ]],
            columns: [[
                { field: 'dVchFromType', title: '工作来源', width: 100, align: 'center' },
                { field: 'dVchActionDep', title: '作业部门', width: 100, align: 'center' },
                { field: 'dVchArea', title: '作业区域', width: 110, align: 'center', formatter: remarkFormater1 },
                { field: 'dDaeWorkStart', title: '作业开始时间', width: 130, align: 'center', formatter: strFormatStartDate },
                { field: 'dVchWorkPeo', title: '作业负责人', width: 80, align: 'center', formatter: strFormatWorkPeo },
                { field: 'dVchWorkPeoQZ', title: '岗位签字', width: 80, align: 'center', formatter: strFormatQZ1 },
                { field: 'dDaeWorkEnd', title: '作业结束时间', width: 130, align: 'center', formatter: strFormatEndDate },
                { field: 'dVchWorkPeo1', title: '作业负责人', width: 80, align: 'center', formatter: strFormatWorkPeo1 },
                { field: 'dVchWorkPeoQZ1', title: '岗位签字', width: 80, align: 'center', formatter: strFormatQZ2 }
            ]],
            toolbar: [{
                text: '新增工作票',
                iconCls: 'icon-add',
                handler: function () {
                    $.ajax({
                        url: '../../ashx/common/SeqValueHandler.ashx?type=gp',
                        type: 'post',
                        dataType: 'text',
                        success: function (msg) {

                            $('#gzp').textbox('setValue', msg);
                        }
                    })
                    $('#tdEquip').datagrid('loadData', { total: 0, rows: [] }); //清空DateGrid 
                    $('#win').window('open'); 

                }
            }, {
                text: '删除工作票',
                iconCls: 'icon-cut',
                handler: function () { delMsgDialog(gzpId); }
            }],

            onLoadSuccess: function (data) {
                $(".note").tooltip({
                    onShow: function () {
                        $(this).tooltip('tip').css({
                            width: '300',
                            boxShadow: '1px 1px 3px #292929'
                        });
                    }
                });
                for (var i = 0; i < data.rows.length; i++) {

                    if (data.rows[i].dDaeWorkStart != undefined) {
                        if (data.rows[i].dDaeWorkStart == "") {
                            $('#starttime-' + i).click(function () {
                                qzMark = 5;

                                $('#timeWin').window('open');
                            })
                        }
                    }

                    if (data.rows[i].dDaeWorkEnd != undefined) {
                        if (data.rows[i].dDaeWorkEnd == "") {
                            $('#endtime-' + i).click(function () {
                                qzMark = 6;
                                $('#timeWin').window('open');
                            })
                        }
                    }


                    if (data.rows[i].Item != undefined) {
                        if (data.rows[i].Item == "") {
                            $('#work-' + i).click(function () {
                                $('#winItem').window('open');
                            })
                        }
                    }

                    if (data.rows[i].dVchWorkPeo != undefined) {
                        if (data.rows[i].dVchWorkPeo == "") {
                            $('#workpeo-' + i).click(function () {
                                qzMark = 1;
                                $('#qzWin').window('open');

                            })
                        }
                    }

                    if (data.rows[i].dVchWorkPeo1 != undefined) {
                        if (data.rows[i].dVchWorkPeo1 == "") {
                            $('#workpeo1-' + i).click(function () {
                                qzMark = 3;
                                $('#qzWin').window('open');
                            })
                        }
                    }


                    if (data.rows[i].dVchWorkPeoQZ != undefined) {
                        if (data.rows[i].dVchWorkPeoQZ == "") {
                            $('#qz1-' + i).click(function () {
                                qzMark = 2;
                                $('#qzWin').window('open');
                            })
                        }
                    }

                    if (data.rows[i].dVchWorkPeoQZ1 != undefined) {
                        if (data.rows[i].dVchWorkPeoQZ1 == "") {
                            $('#qz2-' + i).click(function () {
                                qzMark = 4;
                                $('#qzWin').window('open');
                            })
                        }
                    }
                }
            },
            onSelect: function (index, row) {
                gzpId = row.dVchWorkNote;
                $('#gzpId').textbox('setValue', gzpId);
                $('#qz').textbox('setValue', qzMark);
                showWorkItem(gzpId);
            }
        });
        var p = $('#dg').datagrid('getPager');
        $(p).pagination({
            pageSize: 20, //每页显示的记录条数，默认为20 
            pageList: [10, 20, 50], //可以设置每页记录条数的列表 
            beforePageText: '第', //页数文本框前显示的汉字 
            afterPageText: '页    共 {pages} 页',
            displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'
        });

        $('#tdEquip').datagrid({
            url: '',
            method: 'post',
            singleSelect: true,
            collapsible: true,
            columns: [[
                { field: 'equip_code', title: '设备编码', width: 150, align: 'center', editor: "textbox" },
                { field: 'equip_name', title: '设备名称', width: 130, align: 'center', editor: "textbox" },
                { field: 'dVchWorkContent', title: '作业内容', width: 218, align: 'center', editor: "textbox" },
                { field: 'dVchIsClose', title: '是否停电', width: 80, align: 'center', editor: { type: "combobox", options: { valueField: 'value',
                    textField: 'text',
                    editable: false,
                    panelHeight: 50,
                    data: [{
                        text: '是',
                        value: '是'
                    }, {
                        text: '否',
                        value: '否'
                    }]
                }
                }
                },
                { field: 'dVchApplyPeo', title: '申请人', width: 80, align: 'center', editor: "textbox" }
            ]],
            toolbar: [{
                text: '添加',
                iconCls: 'icon-add',
                handler: function () {
                    $('#tdEquip').datagrid('appendRow', { dVchIsClose: '否' });
                    var rows = $('#tdEquip').datagrid('getRows');
                    $('#tdEquip').datagrid('selectRow', rows.length - 1)
                    $('#tdEquip').datagrid('beginEdit', rows.length - 1);
                }
            }, {
                text: '删除',
                iconCls: 'icon-cut',
                handler: function () { }
            }, {
                text: '保存',
                iconCls: 'icon-save',
                handler: function () {
                    endEdit();
                    //                    alert($('#tdEquip').datagrid('getChanges').length);
                    if ($('#tdEquip').datagrid('getChanges').length) {
                        var inserted = $('#tdEquip').datagrid('getChanges', "inserted");
                        var deleted = $('#tdEquip').datagrid('getChanges', "deleted");
                        var updated = $('#tdEquip').datagrid('getChanges', "updated");

                        effectRow = new Object();
                        //                    alert(JSON.stringify(inserted));
                        if (inserted.length) {
                            effectRow["inserted"] = JSON.stringify(inserted);
                            //                            gzpItem = effectRow["inserted"];
                        }
                        if (deleted.length) {
                            effectRow["deleted"] = JSON.stringify(deleted);
                            //                            gzpItem = effectRow["deleted"];
                        }
                        if (updated.length) {
                            effectRow["updated"] = JSON.stringify(updated);
                            //                            gzpItem = effectRow["updated"];
                        }
                        //                        alert(gzpItem);
                    }

                }
            }],

            onLoadSuccess: function (data) {
                for (var i = 0; i < data.rows.length; i++) {
                    if (data.rows[i].dVchRwContent != undefined) {
                        var content = data.rows[i].dVchRwContent;
                        toolcontent = "<tr><td>具体内容：" + content + " </td></tr>";
                    }
                    //拼写tooltip的内容   
                    tooltipcontent = "<table style='width:200px;'>" + toolcontent + "</table>";
                    addTooltip(tooltipcontent, 'content-' + i);
                }
            },
            onSelect: function (index, row) {
                selRow = row;

                //                alert($('#equipId').val().split(",")[0]);
                //                                if ($('#equipId').val() == "") {
                //                                    alert("请在右侧选择设备！");
                //                                }
                //                                else {
                ////                                    alert($('#equipId').val());
                //                                    selRow.equip_code = $('#equipId').val().split(",")[0];
                //                                    selRow.equip_name = $('#equipId').val().split(",")[1];
                //                                }
            }

        });

        $('#win').window({
            title: '工作票',
            modal: true,
            closed: true,
            minimizable: false,
            collapsible: true
        });

        $('#qzWin').window({
            title: '签字确认',
            modal: true,
            closed: true,
            minimizable: false,
            collapsible: false,
            resizable: false,
            maximizable: false
        });

        $('#timeWin').window({
            title: '时间确认',
            modal: true,
            closed: true,
            minimizable: false,
            collapsible: false,
            resizable: false,
            maximizable: false,
            onBeforeOpen: function () {
                //                alert(getNowTime());
                $('#time').datetimebox('setValue', getNowTime());
            }
        });

        $('#winItem').window({
            title: '作业内容',
            modal: true,
            closed: true,
            minimizable: false,
            collapsible: true,
            onBeforeOpen: function () {
                //                showWorkItem(gzpId);
            }
        });

        $("#WorkCreatUnit").combotree({
            data: getUnitData,
            onSelect: function (node) {
                if (node.attributes == "unit") {
                    $("#WorkCreatUnit").combobox('setValue', '---');
                }
            }
        });
        $("#ActionDep").combotree({
            data: getUnitData,
            onSelect: function (node) {
                if (node.attributes == "unit") {
                    $("#ActionDep").combobox('setValue', '---');
                }
            }
        });
        $('#Area').combotree({
            url: '../../ashx/sbgl/areaHandler.ashx?action=combo&area_parent=0',
            onlyLeafCheck: true,
            onBeforeExpand: function (node) {
                $('#Area').combotree("tree").tree("options").url = "../../ashx/sbgl/areaHandler.ashx?action=combo&area_parent=" + node.id;
            }
        });
        $('#FromType').combobox({
            valueField: 'id',
            textField: 'text',
            editable: false,
            panelHeight: 50,
            data: [{
                id: '1',
                text: '领导安排'
            }, {
                id: '2',
                text: '自我安排'
            }]
        });
    });

    function endEdit() {
        var rows = $('#tdEquip').datagrid('getRows');
        for (var i = 0; i < rows.length; i++) {
//            alert(i);
            $('#tdEquip').datagrid('endEdit', i);
        }
    }

    //选择右侧设备树
    function selEquip() {
//        alert($('#equipId').val());
        var equip_code;
        var equip_name;
        equip_code = $('#equipId').val().split(",")[0];
        equip_name = $('#equipId').val().split(",")[1];
        var rows = $('#tdEquip').datagrid('getRows');
        var index = rows.length - 1;
//        alert(index);
        var ed1 = $('#tdEquip').datagrid('getEditor', { index: index, field: "equip_code" });
        var ed2 = $('#tdEquip').datagrid('getEditor', { index: index, field: "equip_name" });
//        alert(ed1);
        $(ed1.target).textbox('setValue', equip_code);
        $(ed2.target).textbox('setValue', equip_name);
    }

    //关闭窗体
    function closeWin() {
        $('#win').window('close');
        $('#dg').datagrid('reload');
    }
    //关闭窗体
    function closeqzWin() {
        $('#qzWin').window('close');
        $('#dg').datagrid('reload');
        $('#qzName').textbox('clear');
    }

    //关闭窗体
    function closetimeWin() {
        $('#timeWin').window('close');
        $('#dg').datagrid('reload');
        $('#time').textbox('clear');
    }

    function add() {
        var gzp = {
            gzpSeqValue:$("#gzp").val(),
            WorkCreatUnit: $("#WorkCreatUnit").combobox("getText"),
            WorkCreatPeo: $("#WorkCreatPeo").val(),
            WorkSys: $("#WorkSys").datetimebox('getValue'),
            ActionDep: $("#ActionDep").combobox("getText"),
            Area: $("#Area").combobox("getText"),
            FromType: $("#FromType").combobox("getText")
        };

//        alert(effectRow);
        if(effectRow!=undefined) {
            alert(effectRow);
            
            $.ajax({
                url: '../../ashx/rwxt/gzpHandler.ashx?type=add',
                data: gzp,
                type: 'post',
                async: false,
                dataType: 'text',
                success: function (msg) {
                    if (msg == '1') {
                        //                    showMsg("操作提示","添加成功！","info")
                        if (addItem() == '1') {
                            $('#ff').form('clear');
                            showMsg("操作提示", "添加成功！", "info");
                        }
                        else {
                            showMsg("操作提示", "添加失败1！", "error");
                        }
                    }
                    else {
                        showMsg("操作提示", "添加失败2！", "error");
                    }
                }
            })
        }
        else
        {
            showMsg("操作提示","请保存作业项目！","info")
        }
    }

    function addItem() {
        var gzp = $("#gzp").val();
        var out;
        $.ajax({
            url: "../../ashx/rwxt/gzpHandler.ashx?type=additem&gzp=" + gzp,
            data: effectRow,
            type: 'post',
            async: false,
            dataType: 'text',
            success: function (msg) {
                if (msg == 'ok') {
                    $('#tdEquip').datagrid('acceptChanges');
                    out = "1";
                }
                else {
                    out = "-1";
                }
            }
        })
        return out;
    }

    function showWorkItem(gzpId) {
        $('#tdEquipContent').datagrid({
            url: '../../ashx/rwxt/gzpHandler.ashx?type=item&gzpid=' + gzpId,
            method: 'post',
            singleSelect: true,
            collapsible: true,
            columns: [[
                { field: 'equip_code', title: '设备名称', width: 100, align: 'center', hidden:'true' },
                { field: 'equip_name', title: '设备名称', width: 130, align: 'center', editor: "textbox" },
                { field: 'dVchWorkContent', title: '作业内容', width: 218, align: 'center' },
                { field: 'dVchIsClose', title: '是否停电', width: 80, align: 'center' },
                { field: 'dVchApplyPeo', title: '申请人', width: 80, align: 'center' },
                { field: 'dVchZKCheckPeo', title: '中控', width: 80, align: 'center', editor: "textbox" },
                { field: 'dVchActionPeo', title: '执行人', width: 80, align: 'center', editor: "textbox" }
            ]],
            toolbar: [{
                text: '删除',
                iconCls: 'icon-cut',
                handler: function () {
                    if (selRow != undefined) {
                        parent.$.messager.confirm("操作提示", "您确定要执行删除操作吗？", function (data) {
                            if (data) {
                                var row = $('#tdEquipContent').datagrid('getSelected');
                                if (row) {
                                    var rowIndex = $('#tdEquipContent').datagrid('getRowIndex', row);
                                    $('#tdEquipContent').datagrid('deleteRow', rowIndex);
                                }
                            }
                            else {
                            }
                        });
                    }
                    else {
                        parent.$.messager.alert("操作提示", "请选择要删除的数据！", "info");
                    }
                }
            }, {
                text: '提交',
                iconCls: 'icon-undo',
                handler: function () {
                    endEditing();
                    if ($('#tdEquipContent').datagrid('getChanges').length) {
                        var inserted = $('#tdEquipContent').datagrid('getChanges', "inserted");
                        var deleted = $('#tdEquipContent').datagrid('getChanges', "deleted");
                        var updated = $('#tdEquipContent').datagrid('getChanges', "updated");

                        effectRow1 = new Object();
                        if (inserted.length) {
                            effectRow1["inserted"] = JSON.stringify(inserted);
                        }
                        if (deleted.length) {
                            effectRow1["deleted"] = JSON.stringify(deleted);
                        }
                        if (updated.length) {
                            effectRow1["updated"] = JSON.stringify(updated);
                        }
                    }
                }
            }, {
                text: '保存',
                iconCls: 'icon-save',
                handler: function () {
                    var rows = $('#tdEquipContent').datagrid('getChanges');

                    if (rows.length != 0) {
                        if (effectRow1 == undefined) {
                            showMsg("操作提示", "请先提交编辑操作！", "info")
                        }
                        else {
                            updateItem();
                        }
                    }
                }
            }],
            onLoadSuccess: function (data) {
                for (var i = 0; i < data.rows.length; i++) {
                    //                    alert(data);
                }
            },
            onSelect: function (index, row) {
                selRow = row;
            },
            onClickRow: function (index, row) {
                if (editIndex != index) {
                    if (endEditing()) {
                        $('#tdEquipContent').datagrid('selectRow', index);
                        $('#tdEquipContent').datagrid('beginEdit', index);
                        editIndex = index;
                    } else {
                        $('#tdEquipContent').datagrid('selectRow', editIndex);
                    }
                }
            }
        });
    }

    function setStartTime() {
        
    }
    /************************************************************************/
    function updateItem() {
        var gid = $('#gzpId').textbox('getValue');
        $.ajax({
            url: "../../ashx/rwxt/gzpHandler.ashx?type=save&gzpid=" + gid,
            data: effectRow1,
            type: 'post',
            async: false,
            dataType: 'text',
            success: function (msg) {
                if (msg == 'ok') {
                    $('#dg').datagrid('acceptChanges');
                    showMsg("操作提示", "数据更新成功！", "info")
                }
                else {
                    showMsg("操作提示", "数据更新失败！", "error")
                }
            }
        })

        $('#tdEquipContent').datagrid('reload');
    }
    function endEditing() {
        if (editIndex == undefined) { return true }
        if ($('#tdEquipContent').datagrid('validateRow', editIndex)) {
            $('#tdEquipContent').datagrid('endEdit', editIndex);
            editIndex = undefined;
            return true;
        } else {
            return false;
        }
    }
    /************************************************************************/


    //签字
    function update() {
        if (qzMark == 5) {
            var qz5 = {
                ttime: $('#time').datetimebox('getValue'),
                rwdNote: gzpId
            };
            $.ajax({
                url: '../../ashx/rwxt/gzpHandler.ashx?type=qz5',
                data: qz5,
                type: 'post',
                dataType: 'text',
                success: function (msg) {
                    if (msg == '1') {
                        showMsg("操作提示", "时间确认成功！", "info")
                        $('#ff').form('clear');
                    } else {
                        showMsg("操作提示", "时间确认失败！", "error")
                    }
                }
            })
        }

        if (qzMark == 6) {
            var qz6 = {
                ttime: $('#time').datetimebox('getValue'),
                rwdNote: gzpId
            };
            $.ajax({
                url: '../../ashx/rwxt/gzpHandler.ashx?type=qz6',
                data: qz6,
                type: 'post',
                dataType: 'text',
                success: function (msg) {
                    if (msg == '1') {
                        showMsg("操作提示", "时间确认成功！", "info")
                        $('#ff').form('clear');
                    } else {
                        showMsg("操作提示", "时间确认失败！", "error")
                    }
                }
            })
        }


        if (qzMark == 1) {
    
            var qz1 = {
                qzName: $("#qzName").val(),
                rwdNote: gzpId
            };
            $.ajax({
                url: '../../ashx/rwxt/gzpHandler.ashx?type=qz1',
                data: qz1,
                type: 'post',
                dataType: 'text',
                success: function (msg) {
                    if (msg == '1') {
                        showMsg("操作提示", "签字确认成功！", "info")
                        $('#ff').form('clear');
                    } else {
                        showMsg("操作提示", "签字确认失败！", "error")
                    }
                }
            })
        }
        if (qzMark == 2) {

            var qz2 = {
                qzName: $("#qzName").val(),
                rwdNote: gzpId
            };
            $.ajax({
                url: '../../ashx/rwxt/gzpHandler.ashx?type=qz2',
                data: qz2,
                type: 'post',
                dataType: 'text',
                success: function (msg) {
                    if (msg == '1') {
                        showMsg("操作提示", "签字确认成功！", "info")
                        $('#ff').form('clear');
                    } else {
                        showMsg("操作提示", "签字确认失败！", "error")
                    }
                }
            })
        }
        if (qzMark == 3) {

            var qz3 = {
                qzName: $("#qzName").val(),
                rwdNote: gzpId
            };
            $.ajax({
                url: '../../ashx/rwxt/gzpHandler.ashx?type=qz3',
                data: qz3,
                type: 'post',
                dataType: 'text',
                success: function (msg) {
                    if (msg == '1') {
                        showMsg("操作提示", "签字确认成功！", "info")
                        $('#ff').form('clear');
                    } else {
                        showMsg("操作提示", "签字确认失败！", "error")
                    }
                }
            })
        }
        if (qzMark == 4) {

            var qz4 = {
                qzName: $("#qzName").val(),
                rwdNote: gzpId
            };
            $.ajax({
                url: '../../ashx/rwxt/gzpHandler.ashx?type=qz4',
                data: qz4,
                type: 'post',
                dataType: 'text',
                success: function (msg) {
                    if (msg == '1') {
                        showMsg("操作提示", "签字确认成功！", "info")
                        $('#ff').form('clear');
                    } else {
                        showMsg("操作提示", "签字确认失败！", "error")
                    }
                }
            })
        }
    }

    //删除操作提示
    function delMsgDialog(id) {
        $.messager.confirm("操作提示", "您确定要执行删除操作吗？", function (data) {
            if (data) {
                del(id);
            }
            else {
            }
        });
    }

    function del(id) {
        $.ajax({
            url: '../../ashx/rwxt/gzpHandler.ashx?type=del&gzpid=' + id,
            data: null,
            type: 'post',
            dataType: 'text',
            success: function (msg) {
                if (msg == '1') {
                    showMsg("操作提示", "删除成功！", "info")
                    $('#dg').datagrid('reload');
                } else {
                    showMsg("操作提示", "删除失败,该工作票有作业项目关联,无法删除！", "error")
                }
            }
        })
    }

</script>